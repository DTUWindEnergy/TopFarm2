# -*- coding: utf-8 -*-
"""
Created on Thu Jul  4 23:32:16 2024

@author: mikf
"""

import pandas as pd
import numpy as np
import os

from py_wake import Nygaard_2022
from py_wake.site.xrsite import UniformWeibullSite
from py_wake.wind_turbines.generic_wind_turbines import GenericWindTurbine

from topfarm.wind_farm_cluster import TopFarmCluster
from topfarm.utils import downsample_ts, fit_sectorwise_weib
from topfarm.examples import examples_filepath


class EnergyIsland(TopFarmCluster):
    def __init__(self, **kwargs):
        ts_raw = pd.read_csv(os.path.join(examples_filepath, 'input_ts.csv'), sep=',', index_col=0, parse_dates=True)
        ws = ts_raw.WS_150.values
        wd = ts_raw.WD_150.values
        dk1d_tender_9 = np.array([
            695987.1049296035, 6201357.423000679,
            693424.6641628657, 6200908.39284379,
            684555.8480807217, 6205958.057693831,
            683198.5005206821, 6228795.090001539,
            696364.6957258906, 6223960.959626805,
            697335.3172284428, 6204550.027416158, ]).reshape((-1, 2)).T.tolist()

        dk0z_tender_5 = np.array([
            696839.729308316, 6227384.493837256,
            683172.617280614, 6237928.363392656,
            681883.784179578, 6259395.212250201,
            695696.2991147212, 6254559.15746051, ]).reshape((-1, 2)).T.tolist()

        dk0w_tender_3 = np.array([
            706694.3923283464, 6224158.532895836,
            703972.0844905999, 6226906.597455995,
            702624.6334635273, 6253853.5386425415,
            712771.6248419734, 6257704.934445341,
            715639.3355871611, 6260664.6846508905,
            721593.2420745814, 6257906.998015941, ]).reshape((-1, 2)).T.tolist()

        dk0v_tender_1 = np.array([
            695387.9840492046, 6260724.982986244,
            690623.9453331482, 6265534.095966523,
            689790.3527486034, 6282204.661276843,
            706966.9276208277, 6287633.435873629,
            708324.2751808674, 6264796.40356592,
            696034.3037791394, 6260723.0585712865, ]).reshape((-1, 2)).T.tolist()

        dk0Y_tender_4 = np.array([
            688971.224327626, 6289970.317104408,
            699859.6944068453, 6313455.877252994,
            706084.6136432136, 6313894.002391787,
            711981.4247481308, 6312278.1352986405,
            712492.2381035917, 6310678.304996811,
            705728.3384563944, 6295172.010736138,
            703484.1092881403, 6292667.063932351,
            695423.0025504732, 6290179.436863188, ]).reshape((-1, 2)).T.tolist()

        dk0x_tender_2 = np.array([
            715522.0997350881, 6271624.869308893,
            714470.0221534981, 6296972.621665262,
            735902.8674733848, 6290515.568009201,
            726238.5223950314, 6268396.3424808625, ]).reshape((-1, 2)).T.tolist()

        dk1a_tender_6 = np.array([
            741993.8028788125, 6285017.514473925,
            754479.4211245844, 6280870.400239231,
            755733.9969961186, 6260088.643106768,
            753546.8632103675, 6256441.8767611785,
            738552.854493294, 6267674.686871577,
            738130.3486627713, 6276124.151480917, ]).reshape((-1, 2)).T.tolist()

        dk1b_tender7 = np.array([
            730392.0211541882, 6258565.789403263,
            741435.0294020491, 6261729.52759437,
            743007.816872067, 6238891.853815009,
            741806.5300242025, 6237068.79137804,
            729493.7204694732, 6233452.174200128,
            729032.3897788484, 6255601.548896144, ]).reshape((-1, 2)).T.tolist()

        dk1c_tender_8 = np.array([
            719322.3683944925, 6234395.779001247,
            730063.1517509705, 6226372.251569298,
            720738.3338805687, 6206078.654364537,
            712391.7502303863, 6209300.125004388,
            709646.6042396385, 6212504.917381268, ]).reshape((-1, 2)).T.tolist()

        dk1e_tender_10 = np.array([
            705363.6892801415, 6203384.473423205,
            716169.9420085563, 6202667.308115489,
            705315.7291588389, 6178496.656241821,
            693580.7248750407, 6176248.298099114, ]).reshape((-1, 2)).T.tolist()

        x_target = [707087.8354896577,
                    717130.040048451,
                    718245.8405549837,
                    713782.6385288533,
                    704856.2344765925,
                    707087.8354896577,
                    709319.4365027229,
                    704856.2344765925,
                    712666.8380223206,
                    714898.4390353858,
                    708203.6359961902,
                    710435.2370092554,
                    708203.6359961902,
                    705972.034983125,
                    703740.4339700599,
                    705972.034983125,
                    711551.0375157881,
                    720477.4415680489,
                    705972.034983125,
                    709319.4365027229,
                    707087.8354896577,
                    712666.8380223206,
                    713782.6385288533,
                    708203.6359961902,
                    704856.2344765925,
                    705972.034983125,
                    704856.2344765925,
                    711551.0375157881,
                    710435.2370092554,
                    703740.4339700599,
                    704856.2344765925,
                    719361.6410615162,
                    710435.2370092554,
                    710435.2370092554,
                    704856.2344765925,
                    717130.040048451,
                    707087.8354896577,
                    710435.2370092554,
                    704856.2344765925,
                    716014.2395419185,
                    709319.4365027229,
                    711551.0375157881,
                    703740.4339700599,
                    703740.4339700599,
                    712666.8380223206,
                    703740.4339700599,
                    713782.6385288533,
                    714898.4390353858,
                    707087.8354896577,
                    707087.8354896577,
                    703740.4339700599,
                    716014.2395419185,
                    716014.2395419185,
                    710435.2370092554,
                    703740.4339700599,
                    703740.4339700599,
                    716014.2395419185,
                    718245.8405549837,
                    712666.8380223206,
                    713782.6385288533,
                    707087.8354896577,
                    708203.6359961902,
                    710435.2370092554,
                    703740.4339700599,
                    708203.6359961902,
                    717130.040048451]

        y_target = [6243485.3191191,
                    6252075.001884995,
                    6256369.843267943,
                    6258517.263959417,
                    6228453.374278784,
                    6230600.794970257,
                    6254222.422576469,
                    6239190.477736153,
                    6249927.581193522,
                    6252075.001884995,
                    6254222.422576469,
                    6237043.057044678,
                    6249927.581193522,
                    6249927.581193522,
                    6252075.001884995,
                    6243485.3191191,
                    6245632.739810574,
                    6256369.843267943,
                    6226305.953587309,
                    6232748.215661732,
                    6234895.636353205,
                    6241337.898427626,
                    6245632.739810574,
                    6228453.374278784,
                    6249927.581193522,
                    6234895.636353205,
                    6237043.057044678,
                    6239190.477736153,
                    6241337.898427626,
                    6234895.636353205,
                    6226305.953587309,
                    6258517.263959417,
                    6245632.739810574,
                    6247780.160502048,
                    6232748.215661732,
                    6256369.843267943,
                    6254222.422576469,
                    6256369.843267943,
                    6243485.3191191,
                    6258517.263959417,
                    6243485.3191191,
                    6252075.001884995,
                    6232748.215661732,
                    6237043.057044678,
                    6256369.843267943,
                    6249927.581193522,
                    6256369.843267943,
                    6245632.739810574,
                    6245632.739810574,
                    6226305.953587309,
                    6247780.160502048,
                    6252075.001884995,
                    6245632.739810574,
                    6243485.3191191,
                    6241337.898427626,
                    6243485.3191191,
                    6247780.160502048,
                    6252075.001884995,
                    6254222.422576469,
                    6243485.3191191,
                    6228453.374278784,
                    6247780.160502048,
                    6239190.477736153,
                    6239190.477736153,
                    6237043.057044678,
                    6254222.422576469]
        wind_farm_boundaries = [
            dk0w_tender_3,  # target farm
            dk1d_tender_9,
            dk0z_tender_5,
            dk0v_tender_1,
            dk0Y_tender_4,
            dk0x_tender_2,
            dk1a_tender_6,
            dk1b_tender7,
            dk1c_tender_8,
            dk1e_tender_10,
        ]
        target_indicator = 0
        RPs = np.arange(10, 16).astype(int)
        Ds = (240 * np.sqrt(RPs / 15)).astype(int)
        hhs = (Ds / 240 * 150).astype(int)
        wt_list = [GenericWindTurbine(f'WT_{n}', d, h, rp * 10 ** 3) for n, d, h, rp in zip(np.arange(6), Ds, hhs, RPs)]
        wfm = Nygaard_2022
        n_points_x = 18
        n_points_y = 18

        df2 = downsample_ts(ws, wd, ts_raw.index.values, end='2022-01-01')
        As, ks, ps = fit_sectorwise_weib(ws, wd, n_sectors=12)
        site = UniformWeibullSite(ps, As, ks)

        ws_sim = df2.WS
        wd_sim = df2.WD
        time_stamps = df2.index

        TopFarmCluster.__init__(self,
                                wind_farm_boundaries,
                                target_indicator,
                                x_target,
                                y_target,
                                wt_list,
                                wfm,
                                n_points_x,
                                n_points_y,
                                site,
                                ws_sim,
                                wd_sim,
                                time_stamps,
                                **kwargs)
