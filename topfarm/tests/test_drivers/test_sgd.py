import time
import numpy as np
from py_wake.wind_turbines import WindTurbine
from topfarm import TopFarmProblem
from topfarm.cost_models.cost_model_wrappers import CostModelComponent
from topfarm.constraint_components.constraint_aggregation import (
    DistanceConstraintAggregation,
)
from topfarm.constraint_components.boundary import XYBoundaryConstraint, InclusionZone
from py_wake.wind_turbines.power_ct_functions import PowerCtTabular
from topfarm.easy_drivers import EasySGDDriver


def test_extreme_sgd_threshold_value():
    # fmt:off
    x0 = np.array([557673.45977432, 552071.27208098, 555077.87431954, 555888.0917224 ,
        556056.22273425, 557663.1696767 , 559357.19165027, 558015.71139001,
        555476.61849884, 556732.43061143, 557217.69431296, 555848.75994057,
        559324.16982021, 559004.52818348, 558538.94367958, 552546.90113508,
        554407.70034818, 557261.96781708, 554895.41612827, 556703.74836922,
        549384.69441901, 550508.43248942, 553535.30715793, 556229.82630028,
        551741.37160928, 556170.27296573, 554639.08100842, 558353.90239094,
        550636.91008914, 556054.6055312 , 553962.00242905, 552861.44896627,
        558357.98465301])

    y0 = np.array([5847869.83806876, 5838571.33360333, 5847484.10016957,
        5833059.72620785, 5842767.21348615, 5839623.7158992 ,
        5850031.44517493, 5841470.5662811 , 5836373.21186638,
        5834748.74627174, 5837292.7220348 , 5838458.76564209,
        5848327.74986231, 5846653.6501446 , 5845014.11344918,
        5841494.01482513, 5843995.032572  , 5850100.99224499,
        5834700.3592781 , 5846466.54710111, 5840663.66694579,
        5841962.67318398, 5837437.28101766, 5844829.07650891,
        5843225.55284534, 5848792.14526353, 5841350.67178822,
        5851409.15160925, 5839494.42900701, 5840401.50900376,
        5846147.47236965, 5844828.65541853, 5843319.68545303])

    boundaries = np.array([[ 555572.5, 5832506.4],
        [ 556672.6, 5834433.9],
        [ 559589.1, 5849713. ],
        [ 558353.9, 5851409.2],
        [ 549259.1, 5840513.5]])

    p_ws = [3, 3.54953237, 4.067900771, 4.553906848, 5.006427063, 5.424415288, 5.806905228, 6.153012649, 6.461937428, 6.732965398, 6.965470002, 7.158913742, 7.312849418, 7.426921164, 7.500865272, 7.534510799, 7.541241633, 7.58833327, 7.675676842, 7.803070431, 7.970219531, 8.176737731, 8.422147605, 8.70588182, 9.027284445, 9.385612468, 9.780037514, 10.20964776, 10.67345004, 11.13492728, 11.17037214, 11.6992653, 12.25890683, 12.84800295, 13.46519181, 14.10904661, 14.77807889, 15.470742, 16.18543466, 16.92050464, 17.67425264, 18.44493615, 19.23077353, 20.02994808, 20.8406123, 21.66089211, 22.4888912, 23.32269542, 24.1603772, 25]
    p = [375538.6489, 635644.5192, 1014237.244, 1473497.284, 1996315.118, 2571170.922, 3179901.342, 3803380.108, 4421435.886, 5013265.683, 5559920.78, 6043266.596, 6446694.086, 6756659.289, 6962663.346, 7057781.739, 7076914.762, 7211728.426, 7466186.181, 7847828.144, 8367545.594, 9039659.135, 9882192.126, 10918830.42, 12176330.54, 13684381.08, 15971525.41, 18121249.94, 20200106.29, 22000000, 21999982.65, 21999987.72, 22000002.15, 22000000.2, 21999901.99, 22000086.48, 22000044.5, 22000024.7, 22000015.03, 22000009.88, 22000006.73, 22000004.64, 22000003.05, 22000001.73, 22000000.68, 22000396, 21999893.67, 22000001.09, 22000002.82, 22000005.31]
    ct = [0.781330462, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.856986677, 0.774831279, 0.751237387, 0.687365371, 0.63157364, 0.620285375, 0.500707415, 0.417418767, 0.352496626, 0.300020593, 0.256857131, 0.220980221, 0.190956234, 0.165702375, 0.144374588, 0.126299006, 0.110930462, 0.09782423, 0.086614854, 0.07700031, 0.068731176, 0.061595491, 0.055424038, 0.050069939, 0.045412126]
    # fmt:on

    d = 284.0
    hh = 170
    windTurbines = WindTurbine(
        name="IEA Wind Task 37 22MW Offshore Reference Turbine",
        diameter=d,
        hub_height=hh,
        powerCtFunction=PowerCtTabular(p_ws, p, power_unit="W", ct=ct),
    )
    min_spacing_m = 6 * d

    def cost_func(x, y):
        return 5

    def cost_grad_func(x, y):
        return np.random.uniform(-2e-4, 2e-4, size=(2, len(x)))

    maxiter = 3000
    sgd_thresh = 0.9999
    learning_rate = 0.1 * d

    constraint_comp = XYBoundaryConstraint([InclusionZone(boundaries)], "multi_polygon")

    tf = TopFarmProblem(
        design_vars={"x": x0, "y": y0},
        cost_comp=CostModelComponent(
            input_keys=["x", "y"],
            n_wt=len(x0),
            cost_function=cost_func,
            objective=True,
            cost_gradient_function=cost_grad_func,
            maximize=False,
        ),
        constraints=DistanceConstraintAggregation(
            constraint_comp, len(x0), min_spacing_m, windTurbines
        ),
        driver=EasySGDDriver(
            maxiter=maxiter,
            learning_rate=learning_rate,
            speedupSGD=True,
            sgd_thresh=sgd_thresh,
        ),
        plot_comp=None,
    )

    tic = time.time()
    cost, state, recorder = tf.optimize()
    toc = time.time()
    assert recorder["sgd_constraint"][-1] < 1e-6

    print(
        "Optimization with SGD took: {:.0f}s".format(toc - tic),
        " with a total constraint violation of ",
        recorder["sgd_constraint"][-1],
    )
